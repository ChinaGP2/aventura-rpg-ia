<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O Oráculo do Silício</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=EB+Garamond:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body { font-family: 'EB Garamond', serif; overflow-x: hidden; }
        .title-font { font-family: 'Cinzel Decorative', serif; text-shadow: 0 0 10px rgba(253, 224, 71, 0.5); }
        .story-text { white-space: pre-wrap; overflow-wrap: break-word; }
        .action-button { background: linear-gradient(145deg, #b91c1c, #7f1d1d); border: 1px solid #fef08a; color: #fefce8; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4), inset 0 1px 1px rgba(255,255,255,0.2); transition: all 0.2s ease-in-out; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        .action-button:hover:not(:disabled) { background: linear-gradient(145deg, #c82a2a, #902a2a); transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5), inset 0 1px 1px rgba(255,255,255,0.2); }
        .action-button:disabled { background: #57534e; cursor: not-allowed; opacity: 0.6; }
        .secondary-button { background: linear-gradient(145deg, #075985, #0c4a6e); border: 1px solid #7dd3fc; color: #e0f2fe; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4), inset 0 1px 1px rgba(255,255,255,0.2); transition: all 0.2s ease-in-out; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        .secondary-button:hover:not(:disabled) { background: linear-gradient(145deg, #0369a1, #083344); transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5), inset 0 1px 1px rgba(255,255,255,0.2); }
        .secondary-button:disabled { background: #4b5563; cursor: not-allowed; opacity: 0.6; }
        .suggestion-chip { background-color: rgba(12, 74, 110, 0.5); border: 1px solid #7dd3fc; transition: all 0.2s ease-in-out; cursor: pointer; }
        .suggestion-chip:hover { background-color: rgba(3, 105, 161, 0.7); border-color: #e0f2fe; transform: scale(1.05); }
        #background { background-image: url('https://images.unsplash.com/photo-1532009877282-3340270e1c41?q=80&w=1974&auto-format&fit=crop'); background-size: cover; background-position: center; filter: blur(5px) brightness(0.5); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .container-screen { background: radial-gradient(ellipse at center, rgba(17, 24, 39, 0.95) 0%, rgba(17, 24, 39, 0.85) 100%); backdrop-filter: blur(12px); border: 1px solid rgba(253, 224, 71, 0.2); box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 0 15px rgba(253, 224, 71, 0.1); }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.2); border-radius: 50%; border-top-color: #fef08a; width: 40px; height: 40px; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .divider { height: 1px; background: linear-gradient(to right, transparent, rgba(253, 224, 71, 0.5), transparent); margin: 1.5rem 0; }
        .narrate-control { background-color: rgba(253, 224, 71, 0.1); border: 1px solid rgba(253, 224, 71, 0.3); transition: all 0.2s ease-in-out; }
        .narrate-control:hover:not(:disabled) { background-color: rgba(253, 224, 71, 0.2); }
        #narrate-btn.speaking svg, #narrate-btn:disabled svg { color: #fef08a; animation: pulse-speak 1.5s infinite ease-in-out; }
        @keyframes pulse-speak { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .inventory-item { background-color: rgba(0,0,0,0.3); border: 1px solid #a3a3a3; transition: all 0.2s ease-in-out; position: relative; }
        .inventory-item:hover { background-color: rgba(253, 224, 71, 0.1); border-color: #fef08a; }
        .health-bar-background { background-color: #4b5563; border-radius: 0.25rem; overflow: hidden; }
        .health-bar-foreground { background: linear-gradient(to right, #ef4444, #b91c1c); height: 100%; transition: width 0.5s ease-in-out; }
        .character-card { transition: all 0.3s ease-in-out; background: rgba(0,0,0,0.2); border: 1px solid transparent; }
        .character-card.downed { opacity: 0.5; filter: grayscale(80%); }
        .character-card.active-turn { box-shadow: 0 0 15px #fef08a; transform: scale(1.02); border-color: #fef08a; background: rgba(253, 224, 71, 0.05); }
        .character-card.is-me { border-color: rgba(125, 211, 252, 0.7); box-shadow: 0 0 15px rgba(125, 211, 252, 0.5); }
        .session-item { background-color: rgba(0,0,0,0.2); border: 1px solid rgba(253, 224, 71, 0.2); transition: all 0.2s ease-in-out;}
        .session-item:hover { background-color: rgba(253, 224, 71, 0.1); border-color: #fef08a; }
        #map-container { position: relative; width: 100%; padding-top: 66.66%; background-image: url('https://images.unsplash.com/photo-1618012523579-6233d590464f?q=80&w=2070&auto-format&fit=crop'); background-size: cover; border-radius: 0.25rem; overflow: hidden; border: 1px solid rgba(253, 224, 71, 0.2); box-shadow: inset 0 0 15px rgba(0,0,0,0.6); }
        #fog-of-war { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: black; mask-image: radial-gradient(circle 80px at 50% 50%, transparent 50%, black 100%); -webkit-mask-image: radial-gradient(circle 80px at 50% 50%, transparent 50%, black 100%); mask-repeat: no-repeat; -webkit-mask-repeat: no-repeat; transition: mask-position 1s ease-in-out; -webkit-mask-position: 50% 50%; mask-position: 50% 50%; }
        .map-marker { position: absolute; transform: translate(-50%, -50%); font-size: 24px; cursor: pointer; text-shadow: 0 0 5px black; transition: transform 0.2s ease-in-out; }
        .map-marker:hover { transform: translate(-50%, -50%) scale(1.2); }
        .player-marker { animation: pulse 2s infinite; cursor: default !important; }
        @keyframes pulse { 0%, 100% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.2); } 100% { transform: translate(-50%, -50%) scale(1); } }
        #scene-ambience-container { text-shadow: 0 0 10px black; }
        input, select, textarea { box-shadow: inset 0 2px 4px rgba(0,0,0,0.4); }
        input:focus, select:focus, textarea:focus { box-shadow: inset 0 2px 4px rgba(0,0,0,0.4), 0 0 10px rgba(253, 224, 71, 0.5); }
        @keyframes dice-roll-effect { 0%, 100% { transform: scale(1) rotate(0deg); } 25% { transform: scale(1.2) rotate(-10deg); } 75% { transform: scale(1.2) rotate(10deg); } }
        .dice-rolling { animation: dice-roll-effect 0.4s ease-in-out; }
        .tooltip { visibility: hidden; width: 200px; background-color: #111827; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; border: 1px solid #fef08a; font-size: 0.8rem; line-height: 1.2; }
        .inventory-item:hover .tooltip { visibility: visible; opacity: 1; }
        .journal-entry { border-left: 2px solid #fef08a; padding-left: 10px; margin-bottom: 8px; font-size: 0.9rem; color: #d1d5db; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div id="background"></div>

    <div id="entry-container" class="w-full max-w-md container-screen rounded-lg shadow-2xl p-8 text-center">
        <h1 class="text-5xl title-font text-yellow-200 mb-8">O Oráculo do Silício</h1>
        
        <div id="auth-choice-section" class="space-y-4">
            <button id="login-google-btn" class="w-full secondary-button title-font tracking-wider text-lg font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2">
                <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.37,44,30.038,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                Entrar com Google
            </button>
            <div class="relative flex py-2 items-center">
                 <div class="flex-grow border-t border-yellow-200/20"></div>
                 <span class="flex-shrink mx-4 text-yellow-100">ou</span>
                 <div class="flex-grow border-t border-yellow-200/20"></div>
            </div>
            <button id="login-anon-btn" class="w-full secondary-button title-font tracking-wider text-lg font-bold py-3 px-4 rounded-lg">
                Jogar como Anónimo
            </button>
        </div>

        <div id="main-actions" class="hidden">
             <div id="user-display" class="mb-4 text-yellow-100 h-8"></div>
             <div class="space-y-4">
                <button id="host-game-btn" class="w-full action-button title-font tracking-wider text-lg font-bold py-3 px-4 rounded-lg">Ser o Mestre (Criar Aventura)</button>
                <button id="join-room-btn" class="w-full secondary-button title-font tracking-wider text-lg font-bold py-3 px-4 rounded-lg">Juntar-se a uma Aventura</button>
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-yellow-200/20"></div>
                    <span class="flex-shrink mx-4 text-yellow-100">ou</span>
                    <div class="flex-grow border-t border-yellow-200/20"></div>
                </div>
                <button id="solo-play-btn" class="w-full secondary-button title-font tracking-wider text-lg font-bold py-3 px-4 rounded-lg">Jogar a Solo</button>
            </div>
        </div>
        
        <div id="saved-sessions-container" class="mt-8 hidden">
            <div class="divider"></div>
            <h2 class="text-2xl title-font text-yellow-200 mb-4">As Suas Crónicas</h2>
            <div id="saved-sessions-list" class="space-y-3 max-h-48 overflow-y-auto">
                <!-- As sessões serão injetadas aqui -->
            </div>
        </div>
        <p id="auth-status" class="text-gray-400 mt-4 text-sm h-10">A ligar ao servidor...</p>
    </div>

    <div id="join-room-container" class="w-full max-w-md container-screen rounded-lg shadow-2xl p-8 hidden">
        <h1 class="text-4xl title-font text-yellow-200 text-center mb-6">Entrar na Aventura</h1>
        <input type="text" id="room-code-input" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 text-white text-center text-2xl tracking-widest uppercase" placeholder="CÓDIGO DA SALA" maxlength="6">
        <p id="join-error-message" class="text-red-400 text-center mt-4 h-5"></p>
        <div class="mt-4 flex flex-col sm:flex-row gap-4">
            <button id="back-to-entry-btn" class="w-full secondary-button title-font tracking-wider text-lg font-bold py-3 px-4 rounded-lg">Voltar</button>
            <button id="confirm-join-btn" class="w-full action-button title-font tracking-wider text-lg font-bold py-3 px-4 rounded-lg">Entrar</button>
        </div>
    </div>

    <div id="setup-container" class="w-full max-w-2xl container-screen rounded-lg shadow-2xl p-8 hidden">
        <h1 id="setup-title" class="text-4xl title-font text-yellow-200 text-center mb-6">Criar Aventura</h1>
        <div class="mb-4">
            <label for="theme-input" class="block text-sm font-medium text-yellow-100 mb-2">O tema da vossa jornada:</label>
            <div class="flex gap-4">
                <input type="text" id="theme-input" class="flex-grow bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-yellow-400 focus:border-yellow-400" placeholder="Ex: 'Piratas em busca da fonte da juventude'...">
                <button id="generate-classes-btn" class="secondary-button font-bold py-2 px-4 rounded-lg">Gerar Classes</button>
            </div>
        </div>
        <div class="mb-4">
            <label id="player-limit-label" for="player-limit" class="block text-sm font-medium text-yellow-100 mb-2">Limite de jogadores:</label>
            <select id="player-limit" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-yellow-400 focus:border-yellow-400">
                <option value="1">1 Herói</option>
                <option value="2">2 Heróis</option>
                <option value="3" selected>3 Heróis</option>
                <option value="4">4 Heróis</option>
                <option value="5">5 Heróis</option>
                <option value="6">6 Heróis</option>
                <option value="7">7 Heróis</option>
                <option value="8">8 Heróis</option>
            </select>
        </div>
        <div class="divider"></div>
        <p id="error-message" class="text-red-400 text-center mb-4 h-5"></p>
        <div class="mt-6 flex flex-col sm:flex-row gap-4">
            <button id="setup-back-btn" class="w-full secondary-button title-font tracking-wider text-lg font-bold py-3 px-4 rounded-lg">Voltar</button>
            <button id="confirm-setup-btn" class="w-full action-button title-font tracking-wider text-lg font-bold py-3 px-4 rounded-lg">Confirmar Tema e Classes</button>
        </div>
    </div>

    <div id="character-creation-container" class="w-full max-w-2xl container-screen rounded-lg shadow-2xl p-8 hidden">
        <h1 id="character-creation-title" class="text-4xl title-font text-yellow-200 text-center mb-6">Crie o seu Herói</h1>
        <div class="p-4 border border-yellow-200/20 rounded-lg space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <input type="text" id="player-name-input" placeholder="Nome do Herói" class="bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-yellow-400 focus:border-yellow-400">
                <select id="player-class-select" class="bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-yellow-400 focus:border-yellow-400"></select>
            </div>
            <textarea id="player-backstory-textarea" placeholder="Uma breve história do herói..." class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white text-sm focus:ring-yellow-400 focus:border-yellow-400" rows="3"></textarea>
            <div class="divider"></div>
            <div>
                 <p class="text-yellow-100 mb-2">Distribua os seus Pontos de Atributo (<span id="attribute-points-left">4</span> restantes):</p>
                 <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                    <div>
                        <label for="attr-forca" class="block text-sm font-medium">Força</label>
                        <input type="number" id="attr-forca" class="attribute-input w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white text-center" value="0" min="0" max="10">
                    </div>
                    <div>
                        <label for="attr-destreza" class="block text-sm font-medium">Destreza</label>
                        <input type="number" id="attr-destreza" class="attribute-input w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white text-center" value="0" min="0" max="10">
                    </div>
                    <div>
                        <label for="attr-inteligencia" class="block text-sm font-medium">Inteligência</label>
                        <input type="number" id="attr-inteligencia" class="attribute-input w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white text-center" value="0" min="0" max="10">
                    </div>
                    <div>
                        <label for="attr-carisma" class="block text-sm font-medium">Carisma</label>
                        <input type="number" id="attr-carisma" class="attribute-input w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white text-center" value="0" min="0" max="10">
                    </div>
                 </div>
            </div>
        </div>
        <p id="creation-error-message" class="text-red-400 text-center my-4 h-5"></p>
        <div class="mt-6 flex flex-col sm:flex-row gap-4">
             <button id="character-back-btn" class="w-full secondary-button title-font tracking-wider text-lg font-bold py-3 px-4 rounded-lg">Voltar</button>
             <button id="confirm-character-btn" class="w-full action-button title-font tracking-wider text-lg font-bold py-3 px-4 rounded-lg">Confirmar Herói</button>
        </div>
    </div>

    <div id="lobby-container" class="w-full max-w-md container-screen rounded-lg shadow-2xl p-8 hidden text-center">
        <h2 class="text-2xl title-font text-yellow-200">Código da Sala:</h2>
        <p id="room-code-display" class="text-5xl font-bold tracking-widest my-4 bg-gray-900/50 p-4 rounded-lg border border-yellow-200/20 shadow-lg">A GERAR...</p>
        <p class="text-yellow-100">Partilhe este código com os seus amigos.</p>
        <div class="divider"></div>
        <h3 id="lobby-party-status" class="text-xl title-font text-yellow-200">Comitiva Formada:</h3>
        <div id="lobby-players-list" class="my-4 text-left space-y-2"></div>
        <div id="lobby-action-area" class="mt-6">
             <p id="lobby-error-message" class="text-red-400 text-center mb-2 h-5"></p>
        </div>
    </div>

    <div id="game-container" class="w-full max-w-7xl container-screen rounded-lg shadow-2xl p-8 hidden">
        <button id="exit-session-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white" title="Sair da Sessão">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
        </button>
        <div class="flex flex-col lg:flex-row gap-8">
            <div class="flex-grow">
                <div id="scene-ambience-container" class="w-full h-64 bg-gray-900/50 rounded-lg mb-4 flex flex-col items-center justify-center overflow-hidden border border-gray-700 relative text-center p-4">
                    <p id="ambience-icon" class="text-6xl mb-2"></p>
                    <p id="ambience-text" class="text-2xl text-yellow-200 title-font"></p>
                </div>
                <div class="relative">
                     <div class="absolute top-0 right-0 flex items-center gap-2">
                        <button id="voice-toggle-btn" class="narrate-control p-2 rounded-full text-sky-300 hover:text-sky-100" title="Mudar Voz (Feminina/Masculina)">
                           ♀
                        </button>
                        <button id="narrate-btn" class="narrate-control p-2 rounded-full text-yellow-400 hover:text-yellow-200" title="Narrar texto">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.964 15.964a2 2 0 01-2.828 0l-1.13-1.13a2 2 0 00-2.828 0L7.05 17.05a2 2 0 01-2.828 0L2.828 15.657a2 2 0 010-2.828l1.414-1.414a2 2 0 000-2.828L2.828 7.172a2 2 0 010-2.828l1.414-1.414a2 2 0 012.828 0L9.12 4.98a2 2 0 002.828 0l1.13-1.13a2 2 0 012.828 0l1.414 1.414a2 2 0 010 2.828l-1.414 1.414a2 2 0 000 2.828l1.414 1.414a2 2 0 010 2.828l-1.414 1.414z" /></svg>
                        </button>
                    </div>
                    <div id="story-area" class="mb-4 min-h-[150px] pr-24">
                        <p id="story-text" class="text-xl story-text text-gray-300 leading-relaxed"></p>
                    </div>
                </div>
                <div class="divider"></div>
                <div id="action-area">
                    <div id="suggestions-area" class="mb-4">
                        <label class="block text-sm font-medium text-yellow-100 mb-2">Sugestões da IA:</label>
                        <div id="suggestions-chips" class="flex flex-wrap gap-2"></div>
                    </div>
                    <label for="action-input" class="block text-sm font-medium text-yellow-100 mb-2">O que você faz?</label>
                    <div class="flex flex-col sm:flex-row gap-2 items-center">
                        <input type="text" id="action-input" class="flex-grow bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-yellow-400 focus:border-yellow-400" placeholder="Descreva sua ação aqui...">
                        <select id="attribute-select" class="bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-yellow-400 focus:border-yellow-400 w-full sm:w-auto">
                           <option value="forca">Força</option>
                           <option value="destreza">Destreza</option>
                           <option value="inteligencia">Inteligência</option>
                           <option value="carisma">Carisma</option>
                        </select>
                        <div class="flex gap-2 w-full sm:w-auto">
                           <input type="number" id="dice-roll-input" class="bg-gray-800 border border-gray-600 rounded-lg p-2 text-white w-24 text-center" placeholder="d20" min="1" max="20">
                           <button id="roll-dice-btn" class="secondary-button p-2 rounded-lg" title="Lançar um d20">
                               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.5l-8 4.5v9l8 4.5 8-4.5v-9l-8-4.5z"></path><path d="M12 2.5v20"></path><path d="M4 7l8 4.5 8-4.5"></path><path d="M4 16l8-4.5 8 4.5"></path></svg>
                           </button>
                        </div>
                        <button id="perform-action-btn" class="action-button font-bold py-2 px-6 rounded-lg w-full sm:w-auto">Agir!</button>
                    </div>
                    <p id="action-error-message" class="text-red-400 text-center mt-2 h-5"></p>
                    <p class="text-xs text-gray-500 text-center mt-2">O progresso é guardado automaticamente após cada ação.</p>
                </div>
            </div>
            <div class="w-full lg:w-96 flex-shrink-0 flex flex-col lg:max-h-[calc(100vh-4rem)]">
                <div class="overflow-y-auto pr-2">
                    <h2 class="title-font text-2xl text-yellow-200 mb-4">Comitiva</h2>
                    <div id="characters-display" class="space-y-4 mb-6"></div>
                    <div class="divider"></div>
                    <h2 class="title-font text-2xl text-yellow-200 mb-4">O Seu Inventário</h2>
                    <div id="inventory-display" class="space-y-2 mb-6 relative"></div>
                    <div class="divider"></div>
                    <h2 class="title-font text-2xl text-yellow-200 mb-4">Mapa do Mundo</h2>
                    <div id="map-container" class="mb-6">
                        <div id="fog-of-war"></div>
                        <div id="map-markers"></div>
                        <div id="map-tooltip" class="hidden absolute bg-black text-white text-xs rounded py-1 px-2 pointer-events-none z-10"></div>
                    </div>
                    <div class="divider"></div>
                    <h2 class="title-font text-2xl text-yellow-200 mb-4">Diário da Aventura</h2>
                    <div id="journal-display" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-80 flex-col items-center justify-center z-50 hidden">
        <div class="spinner mb-4"></div>
        <p id="loading-text" class="text-xl text-yellow-200 title-font"></p>
    </div>

    <div id="confirmation-modal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="w-full max-w-sm p-6 rounded-lg text-center" style="background: radial-gradient(ellipse at center, rgba(17, 24, 39, 0.95) 0%, rgba(17, 24, 39, 0.85) 100%); border: 1px solid rgba(253, 224, 71, 0.2);">
            <p id="confirmation-message" class="text-lg mb-6">Tem a certeza?</p>
            <div class="flex gap-4">
                <button id="confirm-no-btn" class="w-full secondary-button title-font tracking-wider text-lg font-bold py-2 px-4 rounded-lg">Não</button>
                <button id="confirm-yes-btn" class="w-full action-button title-font tracking-wider text-lg font-bold py-2 px-4 rounded-lg">Sim</button>
            </div>
        </div>
    </div>
     <div id="map-info-modal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="w-full max-w-sm p-6 rounded-lg text-center" style="background: radial-gradient(ellipse at center, rgba(17, 24, 39, 0.95) 0%, rgba(17, 24, 39, 0.85) 100%); border: 1px solid rgba(253, 224, 71, 0.2);">
            <h2 id="map-info-title" class="text-3xl title-font text-yellow-200 mb-4"></h2>
            <button id="map-info-close-btn" class="w-full secondary-button title-font tracking-wider text-lg font-bold py-2 px-4 rounded-lg">Fechar</button>
        </div>
    </div>
    
    <audio id="bg-music" loop src="https://assets.chosic.com/wp-content/uploads/2022/01/Fantasy-Medieval-Music.mp3"></audio>
    <audio id="ambience-sound" loop></audio>
    <audio id="narration-audio"></audio>

    <script type="module">
        // Import Firebase modules from the CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, arrayUnion, collection, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- App Configuration ---
        const GEMINI_API_KEY = "AIzaSyDfO4GbBln20IxuTVNKWf7Z0DldNnVxuU4"; 

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBWUuPnKsxDDpGvI4tG4XaskHmxNAKorhk",
          authDomain: "ia-rpg-64b7f.firebaseapp.com",
          projectId: "ia-rpg-64b7f",
          storageBucket: "ia-rpg-64b7f.firebasestorage.app",
          messagingSenderId: "289306101557",
          appId: "1:289306101557:web:15f2bfa6505a35b3cbee7c"
        };
        
        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const collectionRef = collection(db, "rpg_sessions");

        // --- Global State Variables ---
        let gameState = {};
        let currentUser = null;
        let currentRoomCode = null;
        let unsubscribeFromRoom = null;
        let unsubscribeFromSessions = null;
        let isAINarrating = false;
        let currentVoice = 'Kore'; // 'Kore' = Feminina, 'Charon' = Masculina
        const TOTAL_ATTRIBUTE_POINTS = 4;

        // --- DOM Element References ---
        const allScreens = document.querySelectorAll('.container-screen');
        const entryContainer = document.getElementById('entry-container');
        const authChoiceSection = document.getElementById('auth-choice-section');
        const loginGoogleBtn = document.getElementById('login-google-btn');
        const loginAnonBtn = document.getElementById('login-anon-btn');
        const mainActions = document.getElementById('main-actions');
        const userDisplay = document.getElementById('user-display');
        const soloPlayBtn = document.getElementById('solo-play-btn');
        const hostGameBtn = document.getElementById('host-game-btn');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const authStatus = document.getElementById('auth-status');
        const joinRoomContainer = document.getElementById('join-room-container');
        const roomCodeInput = document.getElementById('room-code-input');
        const confirmJoinBtn = document.getElementById('confirm-join-btn');
        const joinErrorMessage = document.getElementById('join-error-message');
        const backToEntryBtn = document.getElementById('back-to-entry-btn');
        const lobbyContainer = document.getElementById('lobby-container');
        const roomCodeDisplay = document.getElementById('room-code-display');
        const lobbyPlayersList = document.getElementById('lobby-players-list');
        const lobbyActionArea = document.getElementById('lobby-action-area');
        const lobbyErrorMessage = document.getElementById('lobby-error-message');
        const lobbyPartyStatus = document.getElementById('lobby-party-status');
        const setupContainer = document.getElementById('setup-container');
        const setupTitle = document.getElementById('setup-title');
        const playerLimitLabel = document.getElementById('player-limit-label');
        const playerLimitSelect = document.getElementById('player-limit');
        const confirmSetupBtn = document.getElementById('confirm-setup-btn');
        const setupBackBtn = document.getElementById('setup-back-btn');
        const characterCreationContainer = document.getElementById('character-creation-container');
        const characterCreationTitle = document.getElementById('character-creation-title');
        const playerNameInput = document.getElementById('player-name-input');
        const playerClassSelect = document.getElementById('player-class-select');
        const playerBackstoryTextarea = document.getElementById('player-backstory-textarea');
        const creationErrorMessage = document.getElementById('creation-error-message');
        const confirmCharacterBtn = document.getElementById('confirm-character-btn');
        const characterBackBtn = document.getElementById('character-back-btn');
        const gameContainer = document.getElementById('game-container');
        const exitSessionBtn = document.getElementById('exit-session-btn');
        const themeInput = document.getElementById('theme-input');
        const generateClassesBtn = document.getElementById('generate-classes-btn');
        const errorMessage = document.getElementById('error-message');
        const storyTextElement = document.getElementById('story-text');
        const loadingOverlay = document.getElementById('loading-overlay');
        const suggestionsChips = document.getElementById('suggestions-chips');
        const actionInput = document.getElementById('action-input');
        const attributeSelect = document.getElementById('attribute-select');
        const diceRollInput = document.getElementById('dice-roll-input');
        const rollDiceBtn = document.getElementById('roll-dice-btn');
        const performActionButton = document.getElementById('perform-action-btn');
        const actionErrorMessage = document.getElementById('action-error-message');
        const narrateBtn = document.getElementById('narrate-btn');
        const voiceToggleBtn = document.getElementById('voice-toggle-btn');
        const sceneAmbienceContainer = document.getElementById('scene-ambience-container');
        const ambienceIcon = document.getElementById('ambience-icon');
        const ambienceText = document.getElementById('ambience-text');
        const loadingText = document.getElementById('loading-text');
        const charactersDisplay = document.getElementById('characters-display');
        const inventoryDisplay = document.getElementById('inventory-display');
        const journalDisplay = document.getElementById('journal-display');
        const bgMusic = document.getElementById('bg-music');
        const ambienceSound = document.getElementById('ambience-sound');
        const narrationAudio = document.getElementById('narration-audio');
        const mapContainer = document.getElementById('map-container');
        const mapMarkersContainer = document.getElementById('map-markers');
        const fogOfWar = document.getElementById('fog-of-war');
        const mapTooltip = document.getElementById('map-tooltip');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmMessage = document.getElementById('confirmation-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');
        const savedSessionsContainer = document.getElementById('saved-sessions-container');
        const mapInfoModal = document.getElementById('map-info-modal');
        const mapInfoTitle = document.getElementById('map-info-title');
        const mapInfoCloseBtn = document.getElementById('map-info-close-btn');
        let confirmCallback = null;

        // --- Constants ---
        const loadingPhrases = ["Os bardos compõem a vossa canção...", "O destino vira as suas cartas...", "As estrelas alinham-se para a vossa jornada...", "Os ventos da magia sussurram o vosso nome...", "A forja do destino aquece...", "Antigas profecias desenrolam-se..."];
        const STORY_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`;
        
        const soundscapeMap = {
            forest: 'https://assets.chosic.com/wp-content/uploads/2022/01/forest-ambience.mp3',
            cave: 'https://assets.chosic.com/wp-content/uploads/2022/01/cave-ambience.mp3',
            battle: 'https://assets.chosic.com/wp-content/uploads/2021/07/War-Sounds.mp3',
            tavern: 'https://assets.chosic.com/wp-content/uploads/2022/01/medieval-tavern.mp3',
            city: 'https://assets.chosic.com/wp-content/uploads/2022/01/medieval-city.mp3',
            ocean: 'https://assets.chosic.com/wp-content/uploads/2021/04/Ocean-waves.mp3',
            village: 'https://assets.chosic.com/wp-content/uploads/2022/01/medieval-village.mp3',
            dungeon: 'https://assets.chosic.com/wp-content/uploads/2022/01/cave-ambience.mp3', // Reusing cave
            market: 'https://assets.chosic.com/wp-content/uploads/2022/01/medieval-city.mp3', // Reusing city
            default: 'https://assets.chosic.com/wp-content/uploads/2022/01/mysterious-wind.mp3'
        };

        // --- UI Management ---
        function showScreen(screen) {
            allScreens.forEach(c => c.classList.add('hidden'));
            screen.classList.remove('hidden');
        }

        function showConfirmationModal(message, onConfirm) {
            confirmMessage.textContent = message;
            confirmCallback = onConfirm;
            confirmationModal.style.display = 'flex';
        }

        function hideConfirmationModal() {
            confirmCallback = null;
            confirmationModal.style.display = 'none';
        }

        function showLocationInfo(location) {
            mapInfoTitle.textContent = location.location_name;
            mapInfoModal.style.display = 'flex';
        }

        function hideLocationInfo() {
            mapInfoModal.style.display = 'none';
        }
        
        mapInfoCloseBtn.addEventListener('click', hideLocationInfo);
        confirmYesBtn.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            hideConfirmationModal();
        });

        confirmNoBtn.addEventListener('click', hideConfirmationModal);
        
        // --- API Call with Retry Logic ---
        async function fetchWithRetry(url, options, retries = 3, initialDelay = 1000) {
            let delay = initialDelay;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 503 || response.status === 429) {
                        throw new Error(`API Error: ${response.status}`);
                    }
                    if (!response.ok) {
                         const errorData = await response.json().catch(() => ({ error: { message: 'Unknown error structure' } }));
                         console.error("API Error Details:", errorData);
                         throw new Error(`API request failed with status ${response.status}: ${errorData.error.message}`);
                    }
                    return response; // Success
                } catch (error) {
                    console.warn(`Attempt ${i + 1} failed. Retrying in ${delay}ms...`);
                    if (i === retries - 1) throw error; // Last attempt failed, rethrow error
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        }

        // --- Text-to-Speech Narration ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

       function pcmToWav(pcmData, sampleRate) {
            const numSamples = pcmData.byteLength / 2;
            const numChannels = 1;
            const bitsPerSample = 16;
            const blockAlign = (numChannels * bitsPerSample) / 8;
            const byteRate = sampleRate * blockAlign;
            const dataSize = numSamples * numChannels * (bitsPerSample / 8);

            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            writeString(0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(36, 'data');
            view.setUint32(40, dataSize, true);

            const pcmAsInt16 = new Int16Array(pcmData);
            for (let i = 0; i < pcmAsInt16.length; i++) {
                view.setInt16(44 + i * 2, pcmAsInt16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        async function narrateWithAI(text, hint) {
            if (isAINarrating || !text) return;
            isAINarrating = true;
            narrateBtn.disabled = true;
            narrateBtn.classList.add('speaking');
            
            try {
                const prompt = `Fale com um tom ${hint || 'neutro'}: ${text}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { 
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: currentVoice }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const response = await fetchWithRetry(TTS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                const mimeType = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const wavBlob = pcmToWav(pcmData, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    narrationAudio.src = audioUrl;
                    narrationAudio.play().catch(e => {
                        console.error("Erro ao tocar a narração:", e);
                        isAINarrating = false;
                        narrateBtn.disabled = false;
                        narrateBtn.classList.remove('speaking');
                    });
                } else {
                    throw new Error("Dados de áudio inválidos recebidos da API.");
                }

            } catch (error) {
                console.error("Erro na narração com IA:", error);
                isAINarrating = false;
                narrateBtn.disabled = false;
                narrateBtn.classList.remove('speaking');
            }
        }
        
        narrationAudio.onended = () => {
             isAINarrating = false;
             narrateBtn.disabled = false;
             narrateBtn.classList.remove('speaking');
        };
        
        narrateBtn.addEventListener('click', () => {
            if (narrationAudio.paused && gameState.lastUpdate?.text) {
                 narrateWithAI(gameState.lastUpdate.text, gameState.lastUpdate.narration_hint);
            } else {
                 narrationAudio.pause();
                 narrationAudio.currentTime = 0;
                 isAINarrating = false;
                 narrateBtn.disabled = false;
                 narrateBtn.classList.remove('speaking');
            }
        });

        voiceToggleBtn.addEventListener('click', () => {
            if(isAINarrating) return;
            currentVoice = (currentVoice === 'Kore') ? 'Charon' : 'Kore'; // Kore = Feminina, Charon = Masculina
            voiceToggleBtn.innerHTML = (currentVoice === 'Kore') ? '♀' : '♂';
        });

        // --- Sound Effects & Ambience ---
        function playSound(type) {
            Tone.start();
            if (type === 'success') {
                const synth = new Tone.Synth().toDestination();
                synth.triggerAttackRelease("C4", "8n", Tone.now());
                synth.triggerAttackRelease("G4", "8n", Tone.now() + 0.2);
            } else if (type === 'failure') {
                const synth = new Tone.Synth().toDestination();
                synth.triggerAttackRelease("F#2", "8n");
            } else if (type === 'dice') {
                const synth = new Tone.MembraneSynth({
                    pitchDecay: 0.01,
                    octaves: 5,
                    oscillator: { type: 'square' },
                    envelope: {
                        attack: 0.001,
                        decay: 0.1,
                        sustain: 0.01,
                        release: 0.05,
                        attackCurve: 'exponential'
                    }
                }).toDestination();
                synth.volume.value = -15;
                const now = Tone.now();
                synth.triggerAttackRelease("C4", "32n", now);
                synth.triggerAttackRelease("G3", "32n", now + 0.05);
                synth.triggerAttackRelease("E4", "32n", now + 0.1);
                synth.triggerAttackRelease("A3", "32n", now + 0.16);
            }
        }
        
        function updateAmbience(soundscapeKeyword, locationName, icon) {
            // Update visual ambience
            ambienceIcon.textContent = icon || '⚔️';
            ambienceText.textContent = locationName || 'Local Desconhecido';

            // Update audio ambience
            const soundUrl = soundscapeMap[soundscapeKeyword] || soundscapeMap.default;
            if (ambienceSound.src !== soundUrl) {
                ambienceSound.src = soundUrl;
                ambienceSound.volume = 0;
                ambienceSound.play().catch(e => console.log("Playback blocked"));
                
                // Fade in/out logic
                let ambienceVolume = 0;
                const fadeIn = setInterval(() => {
                    ambienceVolume = Math.min(1, ambienceVolume + 0.1);
                    ambienceSound.volume = ambienceVolume * 0.3; // Max ambience volume
                    bgMusic.volume = (1 - ambienceVolume) * 0.1; // Lower main music
                    if (ambienceVolume >= 1) clearInterval(fadeIn);
                }, 100);
            }
        }

        // --- AI Story Generation ---
        async function generateStoryNode(action, attribute, diceRoll) {
            if (GEMINI_API_KEY === "SUA_CHAVE_API_AQUI") {
                storyTextElement.innerText = "A sua chave de API do Google AI Studio não foi adicionada. Por favor, adicione-a ao ficheiro HTML para que a IA possa gerar a história.";
                return;
            }
            const randomIndex = Math.floor(Math.random() * loadingPhrases.length);
            loadingText.textContent = loadingPhrases[randomIndex];
            loadingOverlay.style.display = 'flex';
            
            const activeChar = gameState.characters[gameState.activeCharacterIndex];
            const attributeBonus = activeChar ? (activeChar.attributes[attribute] || 0) : 0;
            const finalRoll = (diceRoll || 0) + attributeBonus;
            
            if (diceRoll) {
                if (finalRoll >= 11) playSound('success'); else playSound('failure');
            }

            const charactersInfo = gameState.characters.map(c => `${c.name} (Classe: ${c.class}, HP: ${c.hp}/${c.maxHp}, Inventário: ${c.inventory.map(i => i.name).join(', ') || 'vazio'})`).join('; ');
            
            let systemPrompt;
            let userQuery;

            const baseJsonResponse = `{
              "text": "...",
              "narration_hint": "um tom de voz (ex: tenso, aliviado, misterioso, zangado).",
              "soundscape_keyword": "uma palavra-chave em inglês (ex: forest, cave, battle, tavern) para o som ambiente.",
              "choices": [ { "text": "Sugestão de ação." }],
              "items_update": [{"character_name": "NomeDoHeroi", "items": [{"name": "Item 1", "description": "Descrição do item."}]}],
              "health_changes": [{"character_name": "NomeDoHeroi", "change": -3}],
              "map_update": {"x": 55, "y": 52, "location_name": "A Floresta Sombria", "icon": "🌳"},
              "journal_entry": "Um resumo de uma frase do evento para o diário.",
              "story_summary": "Um resumo atualizado dos eventos chave."
            }`;

            if (action === "A aventura começa.") {
                systemPrompt = `
                    Você é um Mestre de RPG. O tema é "${gameState.theme}". Os heróis são: ${charactersInfo}.
                    Crie a cena de abertura. Descreva o cenário, a situação inicial, e dê o pontapé inicial. A narração é feita por IA de voz (masculina ou feminina), pode sugerir um tipo de voz no "narration_hint".
                    Sua resposta DEVE ser um objeto JSON válido com a estrutura: ${baseJsonResponse.replace('"..."', '"Narração vívida da cena de abertura..."').replace('"um tom de voz que corresponda à cena (ex: tenso, aliviado, misterioso, zangado)."', '"um tom de voz inspirador e épico."')}
                    A história é em português do Brasil.
                `;
                userQuery = `Comece a aventura.`;
            } else {
                systemPrompt = `
                    Você é um Mestre de RPG. O tema é "${gameState.theme}". Os heróis são: ${charactersInfo}. Resumo da história: ${gameState.storySummary}.
                    O jogador ativo é ${activeChar.name}. Ele usou o atributo ${attribute} (bónus de +${attributeBonus}).
                    A ação do jogador foi: "${action}". O resultado do d20 foi ${diceRoll}. O resultado final (dado + bónus) é ${finalRoll}.
                    Narre o resultado. Considere o atributo usado.
                    - 1: Falha Crítica. - 2-10: Falha. - 11-19: Sucesso. - 20: Sucesso Crítico (d20 natural).
                    Sua resposta DEVE ser um objeto JSON válido com a estrutura: ${baseJsonResponse.replace('"..."', '"Narração vívida do resultado da ação."')}
                    A história é em português do Brasil.
                `;
                userQuery = `Jogador: ${activeChar.name}, Ação: "${action}" com ${attribute}, Rolagem: ${finalRoll} (d20: ${diceRoll} + bónus: ${attributeBonus}).`;
            }

            try {
                const response = await fetchWithRetry(STORY_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } }) });
                const result = await response.json();
                let rawText = result.candidates[0].content.parts[0].text;
                const startIndex = rawText.indexOf('{');
                const endIndex = rawText.lastIndexOf('}');
                if (startIndex === -1 || endIndex === -1) { throw new Error("Resposta da IA não contém um JSON válido."); }
                const jsonText = rawText.substring(startIndex, endIndex + 1);
                const updateData = JSON.parse(jsonText);
                
                const roomRef = doc(collectionRef, currentRoomCode);
                const newGameState = JSON.parse(JSON.stringify(gameState));
                
                if (updateData.items_update) {
                    updateData.items_update.forEach(update => {
                        const char = newGameState.characters.find(c => c.name === update.character_name);
                        if (char && update.items) {
                            char.inventory.push(...update.items);
                        }
                    });
                }
                if (updateData.health_changes) {
                    updateData.health_changes.forEach(change => {
                        const char = newGameState.characters.find(c => c.name === change.character_name);
                        if (char) { char.hp = Math.max(0, Math.min(char.maxHp, char.hp + change.change)); }
                    });
                }
                if (updateData.map_update) {
                    newGameState.map.currentPosition = { x: updateData.map_update.x, y: updateData.map_update.y };
                    const existingLocation = newGameState.map.locations.find(loc => loc.x === updateData.map_update.x && loc.y === updateData.map_update.y);
                    if (!existingLocation) {
                        newGameState.map.locations.push({ ...updateData.map_update });
                    }
                }
                if(updateData.journal_entry){
                    newGameState.journal.push(updateData.journal_entry);
                }
                newGameState.storySummary = updateData.story_summary || newGameState.storySummary;
                newGameState.lastUpdate = updateData;
                newGameState.activeCharacterIndex = (newGameState.activeCharacterIndex + 1) % newGameState.characters.length;
                
                await updateDoc(roomRef, newGameState);

            } catch (error) {
                console.error("Erro ao gerar história:", error);
                storyTextElement.innerText = "Oh, não! Os ventos da magia parecem instáveis. O Mestre de Jogo está a ter dificuldades em contactar os reinos etéreos (serviço indisponível). Por favor, tente novamente dentro de momentos.";
                suggestionsChips.innerHTML = `<button onclick="window.location.reload()" class="w-full action-button font-bold py-3 px-4 rounded-lg">Recomeçar do Zero</button>`;
            } finally { loadingOverlay.style.display = 'none'; }
        }
        
        // --- Game State Rendering ---
        function renderInventory() {
            inventoryDisplay.innerHTML = '';
            const myCharacter = gameState.characters.find(c => c.playerId === currentUser.uid);
            if (!myCharacter || myCharacter.inventory.length === 0) {
                inventoryDisplay.innerHTML = `<p class="text-gray-500 italic">A sua bolsa está vazia.</p>`;
            } else {
                myCharacter.inventory.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'inventory-item text-gray-300 p-2 rounded';
                    itemEl.innerHTML = `
                        ${item.name}
                        <span class="tooltip">${item.description || 'Um item misterioso...'}</span>
                    `;
                    inventoryDisplay.appendChild(itemEl);
                });
            }
        }
        
        function renderJournal() {
            journalDisplay.innerHTML = '';
            if(!gameState.journal || gameState.journal.length === 0) {
                 journalDisplay.innerHTML = `<p class="text-gray-500 italic">A sua jornada ainda não começou...</p>`;
            } else {
                gameState.journal.forEach(entry => {
                    const entryEl = document.createElement('p');
                    entryEl.className = 'journal-entry';
                    entryEl.textContent = entry;
                    journalDisplay.appendChild(entryEl);
                });
                 journalDisplay.scrollTop = journalDisplay.scrollHeight;
            }
        }

        function renderCharacters() {
            charactersDisplay.innerHTML = '';
            if (!gameState.characters) return;
            gameState.characters.forEach((char, index) => {
                const charEl = document.createElement('div');
                let classList = 'p-2 rounded character-card';
                if (char.hp === 0) classList += ' downed';
                if (index === gameState.activeCharacterIndex) classList += ' active-turn';
                if (char.playerId === currentUser.uid) {
                    classList += ' is-me';
                }
                charEl.className = classList;

                const healthPercentage = (char.hp / char.maxHp) * 100;
                const nameLabel = (char.playerId === currentUser.uid && !gameState.isSolo) 
                    ? `${char.name} <span class="text-sky-300 text-sm font-normal">(Você)</span>` 
                    : char.name;
                
                const attributesText = `For: ${char.attributes.forca} | Des: ${char.attributes.destreza} | Int: ${char.attributes.inteligencia} | Car: ${char.attributes.carisma}`;

                charEl.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="font-bold text-lg text-yellow-100">${nameLabel}</p>
                        <p class="text-sm text-gray-300">${char.hp} / ${char.maxHp}</p>
                    </div>
                    <p class="text-sm text-gray-400 mb-1">${char.class}</p>
                    <div class="health-bar-background w-full h-2 mb-2">
                        <div class="health-bar-foreground" style="width: ${healthPercentage}%;"></div>
                    </div>
                    <p class="text-xs text-gray-500">${attributesText}</p>
                `;
                charactersDisplay.appendChild(charEl);
            });
        }

        function renderMap() {
            if (!gameState.map || !mapMarkersContainer) return;
            mapMarkersContainer.innerHTML = '';
            
            gameState.map.locations.forEach(loc => {
                const marker = document.createElement('div');
                marker.className = 'map-marker';
                marker.style.left = `${loc.x}%`;
                marker.style.top = `${loc.y}%`;
                marker.textContent = loc.icon || '📍';
                marker.title = loc.location_name;
                marker.addEventListener('click', () => showLocationInfo(loc));
                mapMarkersContainer.appendChild(marker);
            });

            const playerMarker = document.createElement('div');
            playerMarker.className = 'map-marker player-marker';
            playerMarker.style.left = `${gameState.map.currentPosition.x}%`;
            playerMarker.style.top = `${gameState.map.currentPosition.y}%`;
            playerMarker.textContent = '⚔️';
            playerMarker.title = 'Sua Posição';
            mapMarkersContainer.appendChild(playerMarker);

            fogOfWar.style.maskPosition = `${gameState.map.currentPosition.x}% ${gameState.map.currentPosition.y}%`;
            fogOfWar.style.webkitMaskPosition = `${gameState.map.currentPosition.x}% ${gameState.map.currentPosition.y}%`;
        }
        
        function renderScene(sceneData) {
            storyTextElement.innerText = '';
            suggestionsChips.innerHTML = '';
            actionInput.value = '';
            diceRollInput.value = '';
            
            let charIndex = 0;
            function typeWriter() { 
                if (charIndex < sceneData.text.length) { 
                    storyTextElement.innerText += sceneData.text.charAt(charIndex++); 
                    setTimeout(typeWriter, 20); 
                }
            }
            typeWriter();

            sceneData.choices.forEach(choice => {
                const chip = document.createElement('div');
                chip.innerText = choice.text;
                chip.className = 'suggestion-chip text-sky-100 text-sm py-1 px-3 rounded-full';
                chip.onclick = () => { actionInput.value = choice.text; };
                suggestionsChips.appendChild(chip);
            });
            
            updateAmbience(sceneData.soundscape_keyword, sceneData.map_update?.location_name, sceneData.map_update?.icon);
            renderInventory();
            renderCharacters();
            renderMap();
            renderJournal();
        }

        function renderSavedSessions(sessions) {
            const container = document.getElementById('saved-sessions-container');
            const list = document.getElementById('saved-sessions-list');
            list.innerHTML = '';

            const filteredSessions = sessions.filter(session => session.theme && session.theme.trim() !== '');

            if (filteredSessions.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');

            filteredSessions.forEach(session => {
                const item = document.createElement('div');
                item.className = 'session-item p-3 rounded-lg flex items-center justify-between';
                
                const themeText = document.createElement('p');
                themeText.className = 'text-left text-yellow-100 truncate';
                themeText.textContent = session.theme;
                themeText.title = session.theme;

                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'flex gap-2 flex-shrink-0 ml-4';

                const continueBtn = document.createElement('button');
                continueBtn.textContent = 'Continuar';
                continueBtn.className = 'secondary-button text-sm py-1 px-3 rounded';
                continueBtn.onclick = () => joinRoom(session.id);

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>`;
                deleteBtn.className = 'action-button p-1 rounded';
                deleteBtn.title = 'Apagar Sessão';
                deleteBtn.onclick = () => {
                    showConfirmationModal(
                        `Tem a certeza que quer apagar a aventura "${session.theme}"? Esta ação não pode ser desfeita.`,
                        async () => {
                            const roomRef = doc(collectionRef, session.id);
                            await deleteDoc(roomRef);
                        }
                    );
                };
                
                buttonsDiv.appendChild(continueBtn);
                buttonsDiv.appendChild(deleteBtn);
                item.appendChild(themeText);
                item.appendChild(buttonsDiv);
                list.appendChild(item);
            });
        }

        // --- Main Game Loop / UI Updater ---
        function updateUIWithGameState(data) {
            if (!data) {
                if(unsubscribeFromRoom) unsubscribeFromRoom();
                alert("A sala de jogo já não existe. A regressar ao menu principal.");
                window.location.reload();
                return;
            }

            gameState = data;
            
            if (data.status === 'playing') {
                showScreen(gameContainer);
                if (data.lastUpdate) {
                    renderScene(data.lastUpdate);
                }
                const activeCharacter = gameState.characters[gameState.activeCharacterIndex];
                const isMyTurn = gameState.isSolo || (activeCharacter && activeCharacter.playerId === currentUser.uid);
                performActionButton.disabled = !isMyTurn;
                actionInput.disabled = !isMyTurn;
                attributeSelect.disabled = !isMyTurn;
                diceRollInput.disabled = !isMyTurn;
                rollDiceBtn.disabled = !isMyTurn;
                actionInput.placeholder = isMyTurn ? "É a sua vez de agir!" : `Aguardando a vez de ${activeCharacter?.name}...`;
            } else if (data.status === 'lobby' || data.status === 'setup' || data.status === 'solo_character_creation') {
                const myCharacter = data.characters.find(c => c.playerId === currentUser.uid);

                if ((data.isSolo && data.status === 'solo_character_creation') || (!myCharacter && !data.isSolo)) {
                    showScreen(characterCreationContainer);
                    if(data.isSolo){
                         characterCreationTitle.textContent = `Crie o Herói ${data.characters.length + 1} de ${data.playerLimit}`;
                         confirmCharacterBtn.textContent = (data.characters.length + 1 >= data.playerLimit) ? 'Confirmar e Iniciar Aventura' : 'Confirmar Próximo Herói';
                    } else {
                        characterCreationTitle.textContent = `Crie o seu Herói`;
                    }
                    
                    playerClassSelect.innerHTML = '';
                    if(data.generatedClasses && data.generatedClasses.length > 0) {
                        data.generatedClasses.forEach(cls => {
                            const option = document.createElement('option');
                            option.textContent = cls;
                            playerClassSelect.appendChild(option);
                        });
                    } else {
                         playerClassSelect.innerHTML = `<option>Aguardando classes...</option>`;
                    }
                    playerNameInput.value = '';
                    playerBackstoryTextarea.value = '';
                    document.querySelectorAll('.attribute-input').forEach(input => input.value = 0);
                    document.getElementById('attribute-points-left').textContent = TOTAL_ATTRIBUTE_POINTS;
                } else {
                    showScreen(lobbyContainer);
                    roomCodeDisplay.textContent = currentRoomCode;
                    lobbyPartyStatus.textContent = `Comitiva Formada: ${data.characters.length} / ${data.playerLimit}`;
                    lobbyPlayersList.innerHTML = '';
                    if (data.characters) {
                        data.characters.forEach(char => {
                            if (char.playerId) {
                                const p = document.createElement('div');
                                p.className = 'inventory-item p-2';
                                p.innerHTML = `<p class="font-bold">${char.name} <span class="text-gray-400 font-normal">- ${char.class}</span></p>`;
                                lobbyPlayersList.appendChild(p);
                            }
                        });
                    }
                    
                    lobbyActionArea.innerHTML = '';
                     const lobbyError = document.createElement('p');
                     lobbyError.id = 'lobby-error-message';
                     lobbyError.className = 'text-red-400 text-center mb-2 h-5';
                     lobbyActionArea.appendChild(lobbyError);

                    if (currentUser.uid === data.hostId) {
                        const startButton = document.createElement('button');
                        startButton.id = 'force-start-btn';
                        startButton.className = 'w-full action-button title-font tracking-wider text-lg font-bold py-3 px-4 rounded-lg';
                        startButton.textContent = 'Iniciar Aventura';
                        startButton.onclick = async () => {
                             lobbyError.textContent = '';
                            if (gameState.characters.length === 0) {
                                lobbyError.textContent = 'É necessário pelo menos um herói para iniciar a aventura.';
                                return;
                            }
                            const roomRef = doc(collectionRef, currentRoomCode);
                            await updateDoc(roomRef, { status: 'playing' });
                            await generateStoryNode("A aventura começa.", null, null);
                        };
                        lobbyActionArea.appendChild(startButton);
                    } else {
                        const waitingMessage = document.createElement('p');
                        waitingMessage.className = 'text-gray-400 italic';
                        waitingMessage.textContent = 'Aguardando o Mestre iniciar a aventura...';
                        lobbyActionArea.appendChild(waitingMessage);
                    }
                    
                    const backButton = document.createElement('button');
                    backButton.id = 'lobby-back-btn';
                    backButton.className = 'w-full mt-4 secondary-button title-font tracking-wider text-lg font-bold py-3 px-4 rounded-lg';
                    backButton.textContent = 'Voltar ao Menu';
                    backButton.onclick = () => {
                        if (unsubscribeFromRoom) unsubscribeFromRoom();
                        currentRoomCode = null;
                        showScreen(entryContainer);
                    };
                    lobbyActionArea.appendChild(backButton);
                }
            }
        }

        // --- Room Management ---
        async function joinRoom(roomCode) {
            joinErrorMessage.textContent = '';
            const roomRef = doc(collectionRef, roomCode);
            const roomSnap = await getDoc(roomRef);

            if (!roomSnap.exists()) {
                joinErrorMessage.textContent = 'Sala não encontrada.';
                return;
            }
            
            const roomData = roomSnap.data();
            const isPlayerInRoom = roomData.characters.some(c => c.playerId === currentUser.uid);

            if (roomData.status === 'playing' && !isPlayerInRoom) {
                joinErrorMessage.textContent = 'Esta aventura já começou.';
                return;
            }

            if (roomData.characters.length >= roomData.playerLimit && !isPlayerInRoom) {
                joinErrorMessage.textContent = 'Esta sala já está cheia.';
                return;
            }

            currentRoomCode = roomCode;
            if (unsubscribeFromRoom) unsubscribeFromRoom();
            unsubscribeFromRoom = onSnapshot(roomRef, (doc) => {
                updateUIWithGameState(doc.data());
            });
        }
        
        async function createNewRoom(isSolo = false) {
            try {
                await authReady;
                const roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                const roomRef = doc(collectionRef, roomCode);
                
                currentRoomCode = roomCode;
                
                const initialGameState = {
                    hostId: currentUser.uid,
                    status: 'setup',
                    isSolo: isSolo,
                    players: {},
                    characters: [],
                    theme: '',
                    generatedClasses: [],
                    storySummary: 'A aventura está prestes a começar.',
                    map: { locations: [], currentPosition: {x: 50, y: 50} },
                    activeCharacterIndex: 0,
                    lastUpdate: null,
                    playerLimit: isSolo ? 1 : 3,
                    journal: []
                };
                await setDoc(roomRef, initialGameState);
                
                if (unsubscribeFromRoom) unsubscribeFromRoom();
                unsubscribeFromRoom = onSnapshot(roomRef, (doc) => {
                    const data = doc.data();
                    if(!data) return; 

                    if (data.status === 'setup') {
                        gameState = data;
                        showScreen(setupContainer);
                        setupTitle.textContent = isSolo ? 'Crie a sua Aventura a Solo' : 'Criar Aventura Multijogador';
                        playerLimitLabel.textContent = isSolo ? 'Tamanho da Comitiva:' : 'Limite de jogadores:';
                        if(isSolo) {
                           playerLimitSelect.innerHTML = `<option value="1">1 Herói</option><option value="2">2 Heróis</option><option value="3">3 Heróis</option><option value="4">4 Heróis</option>`;
                        } else {
                           playerLimitSelect.innerHTML = `<option value="2">2 Jogadores</option><option value="3" selected>3 Jogadores</option><option value="4">4 Jogadores</option><option value="5">5 Jogadores</option><option value="6">6 Jogadores</option><option value="7">7 Jogadores</option><option value="8">8 Jogadores</option>`;
                        }
                    } else {
                        updateUIWithGameState(data);
                    }
                });
            } catch (error) {
               console.error("Erro ao criar sala:", error);
               authStatus.innerHTML = `Erro de permissão. <br>Verifique as regras do Firestore na sua consola Firebase.`;
               authStatus.style.display = 'block';
            }
        }
        
        function listenForSavedSessions(userId) {
            if (unsubscribeFromSessions) unsubscribeFromSessions(); 

            const q = query(collectionRef, where("hostId", "==", userId));
            unsubscribeFromSessions = onSnapshot(q, (querySnapshot) => {
                const sessions = [];
                querySnapshot.forEach((doc) => {
                    sessions.push({ id: doc.id, ...doc.data() });
                });
                renderSavedSessions(sessions);
            }, (error) => {
                console.error("Erro ao obter sessões guardadas:", error);
            });
        }

        // --- Event Listeners ---
        hostGameBtn.addEventListener('click', () => createNewRoom(false));
        soloPlayBtn.addEventListener('click', () => createNewRoom(true));
        joinRoomBtn.addEventListener('click', () => showScreen(joinRoomContainer));
        confirmJoinBtn.addEventListener('click', () => {
            const code = roomCodeInput.value.trim().toUpperCase();
            if (code.length === 6) { joinRoom(code); } 
            else { joinErrorMessage.textContent = 'O código deve ter 6 caracteres.'; }
        });
        backToEntryBtn.addEventListener('click', () => {
            showScreen(entryContainer);
            joinErrorMessage.textContent = '';
        });

        setupBackBtn.addEventListener('click', () => {
            if (unsubscribeFromRoom) {
                unsubscribeFromRoom();
                unsubscribeFromRoom = null;
            }
            currentRoomCode = null;
            showScreen(entryContainer);
            errorMessage.textContent = '';
        });

        characterBackBtn.addEventListener('click', () => {
            if (unsubscribeFromRoom) {
                unsubscribeFromRoom();
                unsubscribeFromRoom = null;
            }
            currentRoomCode = null;
            showScreen(entryContainer);
            creationErrorMessage.textContent = '';
        });

        generateClassesBtn.addEventListener('click', async () => {
            if (GEMINI_API_KEY === "SUA_CHAVE_API_AQUI") {
                errorMessage.textContent = 'Por favor, adicione a sua chave de API da IA no código para continuar.';
                return;
            }
            const theme = themeInput.value.trim();
            if (!theme) { errorMessage.textContent = 'Por favor, insira um tema primeiro.'; return; }
            errorMessage.textContent = '';
            generateClassesBtn.textContent = 'Gerando...';
            generateClassesBtn.disabled = true;
            const systemPrompt = `Você é um criador de mundos de RPG. Baseado no tema fornecido, gere uma lista de 4 classes de personagens que se encaixem perfeitamente nesse universo. Responda APENAS com um objeto JSON válido com a seguinte estrutura: {"classes": ["Classe 1", "Classe 2", "Classe 3", "Classe 4"]}.`;
            const userQuery = `O tema é: "${theme}".`;
            try {
                const response = await fetchWithRetry(STORY_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } }) });
                const result = await response.json();
                let rawText = result.candidates[0].content.parts[0].text;
                const startIndex = rawText.indexOf('{');
                const endIndex = rawText.lastIndexOf('}');
                if (startIndex === -1 || endIndex === -1) { throw new Error("Resposta da IA não contém um JSON válido."); }
                const jsonText = rawText.substring(startIndex, endIndex + 1);
                const data = JSON.parse(jsonText);
                
                const roomRef = doc(collectionRef, currentRoomCode);
                await updateDoc(roomRef, { generatedClasses: data.classes });

            } catch (error) { console.error("Erro ao gerar classes:", error); errorMessage.textContent = 'Não foi possível gerar as classes. Tente outro tema.';
            } finally { generateClassesBtn.textContent = 'Gerar Classes'; generateClassesBtn.disabled = false; }
        });

        confirmSetupBtn.addEventListener('click', async () => {
            const themeValue = themeInput.value.trim();
            const playerLimit = parseInt(playerLimitSelect.value, 10);
            if (!themeValue || !gameState.generatedClasses || gameState.generatedClasses.length === 0) {
                errorMessage.textContent = 'Por favor, insira um tema e gere as classes.';
                return;
            }
            errorMessage.textContent = '';
            const roomRef = doc(collectionRef, currentRoomCode);
            
            const nextStatus = gameState.isSolo ? 'solo_character_creation' : 'lobby';
            await updateDoc(roomRef, {
                theme: themeValue,
                playerLimit: playerLimit,
                status: nextStatus
            });
        });
        
        document.querySelectorAll('.attribute-input').forEach(input => {
            input.addEventListener('input', () => {
                let totalPoints = 0;
                document.querySelectorAll('.attribute-input').forEach(i => {
                    totalPoints += parseInt(i.value) || 0;
                });
                const pointsLeft = TOTAL_ATTRIBUTE_POINTS - totalPoints;
                document.getElementById('attribute-points-left').textContent = pointsLeft;
                creationErrorMessage.textContent = pointsLeft < 0 ? 'Você usou mais pontos do que o permitido!' : '';
            });
        });

        confirmCharacterBtn.addEventListener('click', async () => {
            const name = playerNameInput.value.trim();
            const backstory = playerBackstoryTextarea.value.trim();
            const selectedClass = playerClassSelect.value;
            if (!name || !backstory) {
                creationErrorMessage.textContent = 'Por favor, preencha todos os campos.';
                return;
            }

            let totalPoints = 0;
            const attributes = {};
            document.querySelectorAll('.attribute-input').forEach(i => {
                const value = parseInt(i.value) || 0;
                totalPoints += value;
                attributes[i.id.replace('attr-', '')] = value;
            });

            if(totalPoints > TOTAL_ATTRIBUTE_POINTS) {
                creationErrorMessage.textContent = 'Você usou mais pontos do que o permitido!';
                return;
            }
            if(totalPoints < TOTAL_ATTRIBUTE_POINTS) {
                creationErrorMessage.textContent = 'Você ainda tem pontos para distribuir.';
                return;
            }

            creationErrorMessage.textContent = '';

            const newCharacter = { 
                name, 
                class: selectedClass,
                backstory,
                attributes,
                hp: 10 + (attributes.forca * 2), 
                maxHp: 10 + (attributes.forca * 2), 
                playerId: currentUser.uid,
                inventory: []
            };

            const roomRef = doc(collectionRef, currentRoomCode);
            
            if (gameState.isSolo && gameState.characters.length + 1 >= gameState.playerLimit) {
                 await updateDoc(roomRef, {
                    characters: arrayUnion(newCharacter),
                    [`players.${currentUser.uid}`]: 'Jogador Solo',
                    status: 'playing'
                });
                await generateStoryNode("A aventura começa.", null, null);
            } else {
                 await updateDoc(roomRef, {
                    characters: arrayUnion(newCharacter),
                    [`players.${currentUser.uid}`]: name
                });
            }
        });
        
        rollDiceBtn.addEventListener('click', () => {
            playSound('dice');
            rollDiceBtn.disabled = true;
            diceRollInput.classList.add('dice-rolling');

            let rollCount = 0;
            const maxRolls = 10;
            const rollInterval = setInterval(() => {
                diceRollInput.value = Math.floor(Math.random() * 20) + 1;
                rollCount++;
                if (rollCount >= maxRolls) {
                    clearInterval(rollInterval);
                    const finalRoll = Math.floor(Math.random() * 20) + 1;
                    diceRollInput.value = finalRoll;
                    rollDiceBtn.disabled = false;
                    
                    setTimeout(() => {
                        diceRollInput.classList.remove('dice-rolling');
                    }, 400);
                }
            }, 50);
        });

        performActionButton.addEventListener('click', () => {
            const action = actionInput.value.trim();
            const attribute = attributeSelect.value;
            const roll = parseInt(diceRollInput.value, 10);
            if (!action || !roll || roll < 1 || roll > 20) {
                actionErrorMessage.textContent = 'Descreva sua ação e insira uma rolagem de d20 válida (1-20).';
                return;
            }
            actionErrorMessage.textContent = '';
            generateStoryNode(action, attribute, roll);
        });
        
        exitSessionBtn.addEventListener('click', () => {
            if (unsubscribeFromRoom) {
                unsubscribeFromRoom();
                unsubscribeFromRoom = null;
            }
            window.location.reload();
        });

        // --- Authentication Handling ---
        loginGoogleBtn.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => {
                console.error("Erro no login com Google:", error);
                authStatus.textContent = 'Não foi possível iniciar a sessão.';
            });
        });
        
        loginAnonBtn.addEventListener('click', () => {
            signInAnonymously(auth).catch(error => {
                console.error("Falha no login anónimo:", error);
                authStatus.textContent = "Não foi possível ligar ao servidor.";
            });
        });

        const authReady = new Promise(resolve => {
            onAuthStateChanged(auth, (user) => {
                authStatus.style.display = 'none';
                if (user) {
                    currentUser = user;
                    authChoiceSection.classList.add('hidden');
                    mainActions.classList.remove('hidden');

                    if (user.isAnonymous) {
                        userDisplay.innerHTML = `<p>A jogar como anónimo. O progresso não será guardado.</p>`;
                        savedSessionsContainer.classList.add('hidden');
                    } else {
                        userDisplay.innerHTML = `
                            <div class="flex items-center justify-center gap-4">
                                <img src="${user.photoURL}" alt="Avatar" class="w-8 h-8 rounded-full">
                                <p>Bem-vindo, ${user.displayName}!</p>
                                <button id="logout-btn" class="text-sky-300 hover:underline text-sm">(Sair)</button>
                            </div>
                        `;
                        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
                        listenForSavedSessions(user.uid);
                    }
                } else {
                    currentUser = null;
                    authChoiceSection.classList.remove('hidden');
                    mainActions.classList.add('hidden');
                    userDisplay.innerHTML = '';
                    savedSessionsContainer.classList.add('hidden');
                    if (unsubscribeFromSessions) unsubscribeFromSessions();
                }
                resolve(user);
            });
        });

        // --- Page Load Initialization ---
        window.onload = () => {
            document.body.addEventListener('click', () => {
                bgMusic.volume = 0.1;
                if (bgMusic.paused) {
                    bgMusic.play().catch(e => console.log("A reprodução da música foi bloqueada pelo navegador."));
                }
            }, { once: true });
            
            authReady.catch(err => console.error("A autenticação falhou no carregamento da página"));
        };
    </script>
</body>
</html>

